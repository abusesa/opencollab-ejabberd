machine:
  services:
    - docker
  python:
    version: 2.7.10

dependencies:
  pre:
    - pip install https://github.com/abusesa/github-release/archive/master.tar.gz
  override:
    - docker build --pull --rm -t build-image-centos7 centos7
    - docker build --pull --rm -t build-image-ubuntu16.04 ubuntu16.04

test:
  override:
    - docker run -ti --name build-container-centos7 build-image-centos7
    - docker cp build-container-centos7:/home/build/output/. ${CIRCLE_ARTIFACTS}
    - docker run -ti --name build-container-ubuntu16.04 build-image-ubuntu16.04
    - docker cp build-container-ubuntu16.04:/home/build/output/. ${CIRCLE_ARTIFACTS}

deployment:
  release:
    tag: /^build-\d/
    commands:
      - github-release "${GITHUB_API_TOKEN}" "${CIRCLE_PROJECT_USERNAME}" "${CIRCLE_PROJECT_REPONAME}" "${CIRCLE_TAG}" ${CIRCLE_ARTIFACTS}/*
